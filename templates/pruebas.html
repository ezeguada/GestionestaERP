<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Presupuestos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container mt-3" id="contenedor">
        <div class="row mb-2">
            <div class="col">
                <select class="form-select" id="trabajo" style="min-width: 150px;" required>
                    <option value="" selected>Tipo de trabajo</option>
                    {% for trabajo in trabajos %}
                    <option value="{{ trabajo.id }}">{{ trabajo.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col">
                <select class="form-select" id="pago" style="min-width: 150px;" required>
                    <option value="" selected>Tipo de pago</option>
                    {% for cobro in cobros %}
                        <option value="{{ cobro.id }}">{{ cobro.COBRO }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="row mb-2" name="columnatarjeta">
            <div class="col">
                <input type="number" class="form-control" style="max-width: 60px;" id="cantidad" value="1">
            </div>
            <div class="col">
                <select class="form-select" name="producto" required>
                    <option value="" selected>Producto</option>
                    <option value="1" data-valor="15000">Llave algo 1</option>
                    {% for producto in productos %}
                    <option value="{{ producto.id }}" data-valor="{{ producto.efectivo }}">{{ producto.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col">
                <input type="text" class="form-control" name="costo" value="0" disabled>
            </div>
            <div class="col">
                <button class="btn btn-danger" name="eliminar">X</button>
            </div>
        </div>
        
    </div>
    <div class="container mt-3">
        <button class="btn btn-dark" id="mas">+</button>
    </div>

    <script>
        const fila = document.querySelector('[name=columnatarjeta]');
        const nuevo = document.getElementById('mas');
        const eliminar = document.querySelector('[name=eliminar]');
        let lineas = 0

        nuevo.addEventListener('click', () => {
            lineas++;
            const nuevafila = fila.cloneNode(true);
            
            // Actualizar atributos y valores
            nuevafila.setAttribute('name', 'columnatarjeta'+lineas);
            nuevafila.querySelector('[name=costo]').value = 0;
                        
            // Asignar evento de eliminaci√≥n CORREGIDO
            nuevafila.querySelector('[name=eliminar]').addEventListener('click', function() {
                this.closest('.row').remove();
            });
            
            document.getElementById('contenedor').appendChild(nuevafila);
        });

        

        document.getElementById('contenedor').addEventListener('change', function(e) {
            if (e.target && e.target.name === 'producto') {
                const selectedOption = e.target.options[e.target.selectedIndex];
                const costoInput = e.target.closest('.row').querySelector('[name=costo]');
                
                if (selectedOption.value) {
                    costoInput.value = Math.round(parseFloat(selectedOption.dataset.valor));
                } else {
                    costoInput.value = "0";
                }
            }
            
        });
    </script>
</body>
</html>